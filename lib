#!/bin/bash

set -euo pipefail

if [ $# -eq 0 ]; then
    echo "Usage: $0 <library-name>"
    exit 1
fi

# Derive directory name: lib_<arg lowercase>
lib_name="$1"
lower_name=$(echo "$lib_name" | tr '[:upper:]' '[:lower:]')
directory="lib_${lower_name}"

# Create directory and boilerplate files if missing
if [ ! -d "$directory" ]; then
  mkdir -p "$directory"
  touch "$directory/__init__.py"
  cat > "$directory/example.py" << 'PY'
def run():
    pass


if __name__ == '__main__':
    run()
PY
fi

venv_path="$directory/.venv"
if [ ! -d "$venv_path" ]; then
  python3 -m venv "$venv_path"
fi
PIP_BIN="$venv_path/bin/pip"
"$PIP_BIN" install --upgrade pip >/dev/null 2>&1 || true

req_file="$directory/requirements.txt"
if [ -f "$req_file" ]; then
  # If requirements.txt exists in the working directory, install from it
  "$PIP_BIN" install -r "$req_file"
else
  # Otherwise install the requested library and freeze to requirements.txt
  "$PIP_BIN" install "$lib_name"
  "$PIP_BIN" freeze > "$req_file"
fi

root_venv=".venv"
if [ -L "$root_venv" ] || [ -e "$root_venv" ]; then
  rm -rf "$root_venv"
fi
ln -s "$venv_path" "$root_venv"
